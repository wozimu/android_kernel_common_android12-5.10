name: Build GKI Kernel with KernelSU

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget bc bison flex libssl-dev build-essential \
              ccache clang llvm lld make unzip python3 python-is-python3 zip zstd

      - name: Download latest GKI source artifact
        uses: actions/download-artifact@v4
        with:
          name: GKI-common-android12-5.10-lts
          path: source

      - name: Extract GKI source
        run: |
          cd source
          tar -I zstd -xf gki-source.tar.zst
          cd ..

      - name: Apply KernelSU patch
        run: |
          git clone https://github.com/rsuntk/KernelSU.git
          cd KernelSU
          ./patch.sh ../source/common

      - name: Rename kernel version
        run: |
          cd source/common
          sed -i 's/^EXTRAVERSION.*/EXTRAVERSION := -Wozimu-RKSU/' Makefile || echo 'EXTRAVERSION := -Wozimu-RKSU' >> Makefile

      - name: Build kernel (ARM32)
        run: |
          cd source/common
          export PATH=$HOME/clang/bin:$PATH
          export ARCH=arm
          export SUBARCH=arm
          export CC=clang
          export CROSS_COMPILE=arm-linux-gnueabi-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          make O=out gki_defconfig
          make O=out -j$(nproc)
          echo "Build done!"
          file out/arch/arm/boot/Image.gz-dtb

      - name: Prepare AnyKernel3 flashable zip
        run: |
          cd source
          git clone https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf *dtb *img zImage Image Image.gz-dtb
          cp ../common/out/arch/arm/boot/Image.gz-dtb ./ || true
          mkdir -p modules
          find ../common/out/ -name '*.ko' -exec cp {} ./modules/ \; || true

          # Tambahkan modul KernelSU jika ada
          if [ -f ../common/drivers/kernelsu/kernel_su.ko ]; then
            cp ../common/drivers/kernelsu/kernel_su.ko ./modules/
          fi

          # Update deskripsi kernel
          sed -i 's/^kernel.string=.*/kernel.string=Build by Wozimu, Powered by Rissu KernelSU on android12-5.10-LTS Branch/' anykernel.sh || \
          echo 'kernel.string=Build by Wozimu, Powered by Rissu KernelSU on android12-5.10-LTS Branch' >> anykernel.sh

          DATE=$(date +%Y%m%d)
          RUNID=$(printf "%03d" ${{ github.run_number }})
          ZIPNAME="Wozimu-KernelSU-5.10-${DATE}-r${RUNID}.zip"
          echo "ZIPNAME=$ZIPNAME" >> $GITHUB_ENV

          zip -r9 $ZIPNAME . -x .git\*

      - name: Upload AnyKernel3 flashable zip
        uses: actions/upload-artifact@v4
        with:
          name: Wozimu-RKSU
          path: source/AnyKernel3/${{ env.ZIPNAME }}
