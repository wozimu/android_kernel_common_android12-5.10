name: Auto Sync GKI Kernel (common-android12-5.10-lts)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"  # jalan otomatis setiap hari jam 14:00 WIB (07:00 UTC)

jobs:
  sync:
    runs-on: ubuntu-22.04

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget repo zstd jq

      - name: Check latest upstream commit
        id: check-upstream
        run: |
          # Ambil SHA commit terakhir dari branch manifest Google
          LATEST=$(git ls-remote https://android.googlesource.com/kernel/manifest refs/heads/common-android12-5.10-lts | awk '{print $1}')
          echo "LATEST_COMMIT=$LATEST" >> $GITHUB_ENV
          echo "Latest upstream commit: $LATEST"

          # Cek metadata commit terakhir yang tersimpan di repo
          mkdir -p meta
          curl -s -L -o meta/last_commit.txt https://raw.githubusercontent.com/${{ github.repository }}/main/meta/last_commit.txt || true

          if [ -f meta/last_commit.txt ]; then
            LOCAL=$(cat meta/last_commit.txt)
          else
            LOCAL="none"
          fi

          echo "LOCAL_COMMIT=$LOCAL" >> $GITHUB_ENV

          if [ "$LATEST" = "$LOCAL" ]; then
            echo "No update found."
            echo "sync_needed=false" >> $GITHUB_ENV
          else
            echo "New upstream commit detected."
            echo "sync_needed=true" >> $GITHUB_ENV
          fi

      - name: Repo sync GKI kernel (android12-5.10-lts)
        if: env.sync_needed == 'true'
        run: |
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10-lts
          repo sync -c --no-clone-bundle --no-tags -j$(nproc)

          # Arsipkan semua hasil sync ke file terkompresi (tanpa file GitHub)
          tar -I 'zstd -19' -cf gki-source.tar.zst --exclude=.gitignore --exclude=.github *

      - name: Upload synced GKI source
        if: env.sync_needed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: GKI-common-android12-5.10-lts
          path: gki-source.tar.zst

      - name: Save latest commit metadata
        if: env.sync_needed == 'true'
        run: |
          mkdir -p meta
          echo "$LATEST_COMMIT" > meta/last_commit.txt

      - name: Commit and push metadata to repo
        if: env.sync_needed == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git pull
          git add meta/last_commit.txt || true
          git commit -m "Update GKI sync metadata to $LATEST_COMMIT" || true
          git push
