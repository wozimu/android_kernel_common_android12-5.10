jobs:
  sync:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget repo zstd jq

      - name: Check latest upstream commit
        id: check-upstream
        run: |
          LATEST=$(git ls-remote https://android.googlesource.com/kernel/manifest refs/heads/common-android12-5.10-lts | awk '{print $1}')
          echo "LATEST_COMMIT=$LATEST" >> $GITHUB_ENV
          echo "Latest commit upstream: $LATEST"
          mkdir -p meta
          curl -s -L -o meta/last_commit.txt https://raw.githubusercontent.com/${{ github.repository }}/main/meta/last_commit.txt || true
          if [ -f meta/last_commit.txt ]; then
            LOCAL=$(cat meta/last_commit.txt)
          else
            LOCAL="none"
          fi
          echo "LOCAL_COMMIT=$LOCAL" >> $GITHUB_ENV
          if [ "$LATEST" = "$LOCAL" ]; then
            echo "sync_needed=false" >> $GITHUB_ENV
          else
            echo "sync_needed=true" >> $GITHUB_ENV
          fi

      - name: Repo sync GKI kernel (android12-5.10-lts)
        if: env.sync_needed == 'true'
        run: |
          mkdir gki && cd gki
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10-lts
          repo sync -c --no-clone-bundle --no-tags --force-sync -j$(nproc)
          cd ..
          tar -I 'zstd -19' -cf gki-source.tar.zst gki

      - name: Upload synced GKI source
        if: env.sync_needed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: GKI-common-android12-5.10-lts
          path: gki-source.tar.zst

      - name: Save latest commit metadata
        if: env.sync_needed == 'true'
        run: |
          mkdir -p meta
          echo "$LATEST_COMMIT" > meta/last_commit.txt

      - name: Commit and push metadata to repo
        if: env.sync_needed == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add meta/last_commit.txt
          git commit -m "Update GKI sync metadata to $LATEST_COMMIT" || true
          git push
